/*! stackmob-js-sdk 1.0.0 *//*!
 StackMob JS SDK Version 1.0.0
 Copyright 2012-2013 StackMob Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 */
!function(){var a=this,b="undefined"!=typeof window?window:{location:{hostname:"api.stackmob.com",port:"443",protocol:"https:"}};b.StackMob=a.StackMob={DEFAULT_API_VERSION:0,DEFAULT_LOGIN_SCHEMA:"user",DEFAULT_LOGIN_FIELD:"username",DEFAULT_PASSWORD_FIELD:"password",EARTH_RADIANS_MI:3956.6,EARTH_RADIANS_KM:6367.5,FORCE_CREATE_REQUEST:"stackmob_force_create_request",ARRAY_FIELDNAME:"stackmob_array_fieldname",ARRAY_VALUES:"stackmob_array_values",CASCADE_DELETE:"stackmob_cascade_delete",HARD_DELETE:!0,SOFT_DELETE:!1,API_SERVER:"api.stackmob.com",RETRY_WAIT:1e4,RETRY_ATTEMPTS:3,REFRESH_TOKEN_KEY:"oauth2.refreshToken",POST:"POST",PUT:"PUT",DELETE:"DELETE",CONTENT_TYPE_JSON:"application/json",SECURE_ALWAYS:"ALWAYS",SECURE_MIXED:"MIXED",SECURE_NEVER:"NEVER",apiVersion:0,sdkVersion:"1.0.0",publicKey:null,getProtocol:function(){return b.location.protocol},getHostname:function(){return b.location.hostname},getPort:function(){return b.location.port},Storage:{STORAGE_PREFIX:"stackmob.",persist:function(a,b){localStorage&&localStorage.setItem(this.STORAGE_PREFIX+a,b)},retrieve:function(a){return localStorage?localStorage.getItem(this.STORAGE_PREFIX+a):null},remove:function(a){localStorage&&localStorage.removeItem(this.STORAGE_PREFIX+a)}},_generateCallbacks:function(a,b){return a=a||{},a.success=function(a){b.isValidResult(a)?"function"==typeof b.yes&&b.yes(a):"function"==typeof b.no&&b.no(a)},a.error||"function"!=typeof b.error||(a.error=b.error),a},_containsCallbacks:function(a,b){return"object"==typeof a&&_.some(b,function(b){return"function"==typeof a[b]})},getLoggedInUser:function(a){var b=!this.isOAuth2Mode()&&this.Storage.retrieve(this.loggedInUserKey)||this.Storage.retrieve("oauth2.user");return a&&a.success?(this.hasValidOAuth(a),void 0):this.isLoggedIn(a)&&b?b:null},isLoggedIn:function(a){return this._containsCallbacks(a,["yes","no"])?(a=this._generateCallbacks(a,{isValidResult:function(a){return"undefined"!=typeof a},yes:a.yes,no:a.no,error:a.no}),this.hasValidOAuth(a),void 0):!this.isLoggedOut()||this.hasValidOAuth(a)},isUserLoggedIn:function(a,b){return this._containsCallbacks(b,["yes","no"])?(b=this._generateCallbacks(b,{isValidResult:function(b){return b==a},yes:b.yes,no:b.no,error:b.no}),this.hasValidOAuth(b),void 0):a==this.getLoggedInUser(b)},isLoggedOut:function(a){return this._containsCallbacks(a,["yes","no"])?(a=this._generateCallbacks(a,{isValidResult:function(a){return"undefined"==typeof a},yes:a.yes,no:a.no,error:a.yes}),this.hasValidOAuth(a),void 0):!this.hasValidOAuth(a)},getBaseURL:function(){return StackMob.useRelativePathForAjax?StackMob.apiDomain?StackMob.apiDomain:this.getHostname()+(this.getPort()?":"+this.getPort():"")+"/":StackMob.apiDomain?StackMob.apiDomain:StackMob.API_SERVER+"/"},throwError:function(a){throw new Error(a)},urlError:function(){this.throwError('A "url" property or function must be specified')},requirePublicKey:function(){StackMob.publicKey||this.throwError("Error: This requires that you initialize StackMob with a public key.")},isOAuth2Mode:function(){return!isNaN(StackMob.publicKey&&!StackMob.privateKey)},prepareCredsForSaving:function(a,b,c,d,e,f){var g=(new Date).getTime()+1e3*this._stubbedExpireTime(d),h={"oauth2.accessToken":a,"oauth2.macKey":c,"oauth2.expires":g,"oauth2.user":e,"oauth2.userSchemaInfo":f};return h[StackMob.REFRESH_TOKEN_KEY]=b,h},_stubbedExpireTime:function(a){return a},saveOAuthCredentials:function(a){var b=a["oauth2.accessToken"],c=a[StackMob.REFRESH_TOKEN_KEY];this.Storage.retrieve("oauth2.accessToken")!=b&&this.Storage.persist("oauth2.expires",a["oauth2.expires"]),this.Storage.persist("oauth2.accessToken",b),this.Storage.persist(StackMob.REFRESH_TOKEN_KEY,c),this.Storage.persist("oauth2.macKey",a["oauth2.macKey"]),this.Storage.persist("oauth2.user",a["oauth2.user"]),this.Storage.persist("oauth2.userSchemaInfo",JSON.stringify(a["oauth2.userSchemaInfo"]))},hasValidOAuth:function(a){if(a=a||{},!this.isOAuth2Mode())return a&&a.error&&a.error(),!1;var b=this.getOAuthCredentials(),c=b&&b["oauth2.expires"]||0;if(!_.all([b["oauth2.accessToken"],b["oauth2.macKey"],c],_.identity))return a&&a.success&&a.success(void 0),!1;if(!StackMob.hasExpiredOAuth())return a&&a.success&&a.success(this.Storage.retrieve("oauth2.user")),this.Storage.retrieve("oauth2.user");if(!a||!a.success)return!1;var d=a.success;a.success=function(a){var b=StackMob.getOAuthCredentials(),c=b["oauth2.userSchemaInfo"]&&b["oauth2.userSchemaInfo"].loginField?b["oauth2.userSchemaInfo"].loginField:this.loginField;d(a[c])},this.initiateRefreshSessionCall(a)},initiateRefreshSessionCall:function(a){StackMob.refreshSession.call(StackMob,a)},shouldSendRefreshToken:function(){return this.hasExpiredOAuth()&&this.hasRefreshToken()&&this.shouldKeepLoggedIn()},keepLoggedIn:function(a){StackMob.Storage.persist("oauth2.shouldKeepLoggedIn",a===!0)},shouldKeepLoggedIn:function(){return"true"===StackMob.Storage.retrieve("oauth2.shouldKeepLoggedIn")},hasRefreshToken:function(){var a=this.getOAuthCredentials();return a&&"undefined"!=typeof a[StackMob.REFRESH_TOKEN_KEY]&&null!==a[StackMob.REFRESH_TOKEN_KEY]},getRefreshToken:function(){var a=this.getOAuthCredentials();return a[StackMob.REFRESH_TOKEN_KEY]},hasExpiredOAuth:function(){return this.isOAuth2Mode()&&null===this.getOAuthExpireTime()||this.getOAuthExpireTime()<=(new Date).getTime()},clearOAuthCredentials:function(){StackMob.Storage.remove(StackMob.loggedInUserKey),StackMob.Storage.remove("oauth2.accessToken"),StackMob.Storage.remove(StackMob.REFRESH_TOKEN_KEY),StackMob.Storage.remove("oauth2.macKey"),StackMob.Storage.remove("oauth2.expires"),StackMob.Storage.remove("oauth2.user"),StackMob.Storage.remove("oauth2.userSchemaInfo")},getOAuthCredentials:function(){var a=StackMob.Storage.retrieve("oauth2.accessToken"),b=StackMob.Storage.retrieve("oauth2.macKey"),c=StackMob.Storage.retrieve("oauth2.expires"),d=StackMob.Storage.retrieve(StackMob.REFRESH_TOKEN_KEY),e=StackMob.Storage.retrieve("oauth2.userSchemaInfo"),f=null;try{f=JSON.parse(e)}catch(g){}if(_.every([a,b,c,d,f])){var h={"oauth2.accessToken":a,"oauth2.macKey":b,"oauth2.expires":c,"oauth2.userSchemaInfo":f};return h[StackMob.REFRESH_TOKEN_KEY]=d,h}return{}},getOAuthExpireTime:function(){var a=this.Storage.retrieve("oauth2.expires");return a?parseInt(a,10):null},METHOD_MAP:{create:"POST",read:"GET",update:"PUT","delete":"DELETE",post:"POST",get:"GET",put:"PUT",addRelationship:"POST",appendAndSave:"PUT",deleteAndSave:"DELETE",login:"GET",accessToken:"POST",refreshToken:"POST",logout:"GET",forgotPassword:"POST",loginWithTempAndSetNewPassword:"GET",resetPassword:"POST",facebookAccessToken:"POST",facebookAccessTokenWithCreate:"POST",createUserWithFacebook:"POST",linkUserWithFacebook:"GET",unlinkUserFromFacebook:"DELETE",gigyaAccessToken:"POST",linkUserWithGigya:"POST",unlinkUserFromGigya:"DELETE"},getProperty:function(a,b){return a&&a[b]?_.isFunction(a[b])?a[b]():a[b]:null},init:function(a){if(a=a||{},this.initStart(a),this.userSchema=a.userSchema,this.loginField=a.loginField,this.passwordField=a.passwordField,this.newPasswordField="new_password",this.publicKey=a.publicKey,this.apiVersion=a.apiVersion||this.DEFAULT_API_VERSION,"undefined"!=typeof a.apiURL)throw new Error("Error: apiURL is no longer supported.  The API URL is now automatically set for PhoneGap users.");var b=a.apiDomain;if("string"==typeof b){if(0===b.indexOf("http"))throw new Error("Error: apiDomain should not specify url scheme (http/https). For example, specify api.stackmob.com instead of http://api.stackmob.com. URL Scheme is determined by the 'secure' init variable.");this.apiDomain=b.indexOf("/")==b.length-1?b:b+"/"}var c=this.getHostname().indexOf(".stackmobapp.com")>0;return this.useRelativePathForAjax="boolean"==typeof a.useRelativePathForAjax?a.useRelativePathForAjax:c,this.secure=a.secure?a.secure:0===this.getProtocol().indexOf("https:")?this.SECURE_ALWAYS:0===this.getProtocol().indexOf("http:")?this.SECURE_NEVER:this.SECURE_MIXED,this.ajax=a.ajax||this.ajax,this.initEnd(a),this},initStart:function(){},initEnd:function(){},wrapStackMobCallbacks:function(){}}}.call(this),function(){function a(a,b,c,d,e,f){var g="\n";return a+g+b+g+c+g+d+g+e+g+f+g+g}function b(b,c,d,e,f,g){var h=e.split(":"),i=h.length>1?h[0]:e,j=h.length>1?h[1]:"https"==g.substring(0,5)?443:80,k=Math.round((new Date).getTime()/1e3),l="n"+Math.round(1e4*Math.random()),m=a(k,l,b,f,i,j),n=CryptoJS.HmacSHA1(m,d),o=n.toString(CryptoJS.enc.Base64);return'MAC id="'+c+'",ts="'+k+'",nonce="'+l+'",mac="'+o+'"'}function c(a){var c=a.url.match(/(^http|^https):\/\//g),d=c+StackMob.getBaseURL(),e=a.url.replace(new RegExp(d,"g"),"/"),f=d.replace(new RegExp("^http://|^https://","g"),"").replace(new RegExp("/"),""),g=StackMob.Storage.retrieve("oauth2.accessToken"),h=StackMob.Storage.retrieve("oauth2.macKey");if(StackMob.Storage.retrieve("oauth2.expires"),StackMob.isOAuth2Mode()&&g&&h){var i=b(a.type,g,h,f,e,d);return i}}function d(a,b){b=b||{};var c,d="http",e="https";if(b.secureRequest===!0)c=e;else switch(StackMob.secure){case StackMob.SECURE_ALWAYS:c=e;break;case StackMob.SECURE_NEVER:c=d;break;default:c=StackMob._isSecureMethod(a,b)?e:d}return c+"://"}function e(a,b,c){if(c=c||{},b.headers=b.headers||{},b.headers=_.extend(b.headers,{Accept:"application/vnd.stackmob+json; version="+StackMob.apiVersion}),_.extend(b.headers,{"X-StackMob-User-Agent":"StackMob (JS; "+StackMob.sdkVersion+")"}),StackMob.publicKey&&!StackMob.privateKey?(b.headers["X-StackMob-API-Key"]=StackMob.publicKey,b.headers["X-StackMob-Proxy-Plain"]="stackmob-api",b.headers["X-StackMob-API-Key-"+StackMob.publicKey]="1"):b.headers["X-StackMob-Proxy"]="stackmob-api",StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(a)?b.contentType="application/x-www-form-urlencoded":_.include(["PUT","POST"],StackMob.METHOD_MAP[a])&&(b.contentType=b.contentType||StackMob.CONTENT_TYPE_JSON),isNaN(c[StackMob.CASCADE_DELETE])||(b.headers["X-StackMob-CascadeDelete"]=c[StackMob.CASCADE_DELETE]===!0),c.query){var d=b.query||throwError("No StackMobQuery object provided to the query call.");if(d.selectFields&&d.selectFields.length>0&&(b.headers["X-StackMob-Select"]=d.selectFields.join()),d.range&&(b.headers.Range="objects="+d.range.start+"-"+d.range.end),_.extend(b.data,d.params),d.orderBy&&d.orderBy.length>0){for(var e=d.orderBy,f="",g=e.length,h=0;g>h;h++)f+=e[h],g>h+1&&(f+=",");b.headers["X-StackMob-OrderBy"]=f}}}function f(a){a=a||{},a.processData=!1,a.accepts=a.headers.Accept}function g(a,b){if(!StackMob.isAccessTokenMethod(a)){var d=c(b);d&&(b.headers.Authorization=d)}}var h=this;h.jQuery||h.Ext||h.Zepto,_.extend(StackMob,{isSencha:function(){return h.Ext},isZepto:function(){return h.Zepto},initEnd:function(){i(),j(),k()},cc:function(a,b,c,d){return this.customcode(a,b,c,d)},customcode:function(a,b,c,e){function f(a){return a&&!_.isUndefined(StackMob.METHOD_MAP[c.toLowerCase()])}if(_.isObject(c)){e=c||{};var g=e.httpVerb;e.httpVerb=f(g)?g:"GET"}else e=e||{},_.isString(c)&&f(c)&&(e.httpVerb=c.toUpperCase());return e.data=e.data||{},"GET"!==c&&(e.contentType=e.contentType||StackMob.CONTENT_TYPE_JSON),_.extend(e.data,b),e.url=d(a,b)+this.getBaseURL(),this.sync.call(StackMob,a,null,e)},processLogin:function(a,b){if(StackMob.isOAuth2Mode()){var c=a,d=c.access_token,e=c.refresh_token,f=c.mac_key,g=c.expires_in;try{var h=StackMob.getOAuthCredentials(),i=b.stackmob_userschemainfo||h["oauth2.userSchemaInfo"],j=i.loginField,k=a.stackmob.user[j],l=StackMob.prepareCredsForSaving(d,e,f,g,k,i);StackMob.saveOAuthCredentials(l),StackMob.Storage.persist(StackMob.loggedInUserKey,k)}catch(m){console&&console.error("Problem saving OAuth 2.0 credentials and user: "+m)}}},sync:function(a,b,c){function h(a,b,e){e=e||{};var f=d(b,e);!e.url&&a&&(e.url=f+a.url());var g="cc"!=b,h=a&&a.isNew&&!a.isNew(),i=!o,k="addRelationship"==b||"appendAndSave"==b||"deleteAndSave"==b;if(j(b)){var l=b;e.url+=("/"==e.url.charAt(e.url.length-1)?"":"/")+l}else if((k||g&&h&&i)&&(e.url+=("/"==e.url.charAt(e.url.length-1)?"":"/")+encodeURIComponent(a.get(a.getPrimaryKeyField())),k&&(e.url+="/"+c[StackMob.ARRAY_FIELDNAME]),"deleteAndSave"==b)){var m="";m=_.isArray(c[StackMob.ARRAY_VALUES])?_.map(c[StackMob.ARRAY_VALUES],function(a){return encodeURIComponent(a)}).join(","):encodeURIComponent(c[StackMob.ARRAY_VALUES]),e.url+="/"+m}}function i(a,c,d){function e(a){var b=_.map(_.keys(a),function(b){return b+"="+encodeURIComponent(a[b])});return b.join("&")}if(d=d||{},StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(a))c.data=e(c.data);else if("POST"==c.type||"PUT"==c.type)if("resetPassword"==a||"forgotPassword"==a)c.data=JSON.stringify(c.data);else if("addRelationship"==a||"appendAndSave"==a)d&&d[StackMob.ARRAY_VALUES]&&(c.data=JSON.stringify(d[StackMob.ARRAY_VALUES]));else if(b){var f=b.toJSON(),g=d.remote_ignore||[];if(_.each(g,function(a){delete f[a]}),delete f.lastmoddate,delete f.createddate,"update"==a){var h=d.stackmob_userschemainfo||StackMob.getOAuthCredentials()["oauth2.userSchemaInfo"];if(h){var i=h.passwordField;delete f[i]}_.each(b.getBinaryFields(),function(a){f[a]&&0===f[a].indexOf("http")&&delete f[a]})}StackMob.isOAuth2Mode()&&delete f.sm_owner,c.data=JSON.stringify(_.extend(f,c.data))}else c.data=JSON.stringify(c.data);else if("GET"==c.type||"DELETE"==c.type){if(!_.isEmpty(c.data)){c.url+="?";var j=e(c.data);c.url+=j}delete c.data}else delete c.data}function j(a){return!_.include(["create","update","delete","read","query","deleteAndSave","appendAndSave","addRelationship"],a)}if(c=c||{},!StackMob.isAccessTokenMethod(a)&&StackMob.shouldSendRefreshToken()&&c.stackmob_attempted_refresh!==!0){var k=a,l=c;l.stackmob_attempted_refresh=!0;var m=b,n=this;return StackMob.refreshSession.call(StackMob,{oncomplete:function(){StackMob.sync.call(n,k,m,l)}}),!1}var o=c[StackMob.FORCE_CREATE_REQUEST]===!0;o&&(a="create");var p=c.httpVerb||StackMob.METHOD_MAP[a]||"GET",q=_.extend({type:p},c);return q.data=q.data||{},h(b,a,q),e(a,q,c),i(a,q,c),f(q),g(a,q),StackMob.makeAPICall(b,q,a,c)},refreshSession:function(a){var b={};if(_.extend(b,a),StackMob.hasRefreshToken()){var c=StackMob.getOAuthCredentials()["oauth2.userSchemaInfo"]?StackMob.getOAuthCredentials()["oauth2.userSchemaInfo"].schemaName:StackMob.userSchema;b.url=d("refreshToken")+this.getBaseURL()+c,b.contentType="application/x-www-form-urlencoded",b.data={refresh_token:StackMob.getOAuthCredentials()[StackMob.REFRESH_TOKEN_KEY],grant_type:"refresh_token",token_type:"mac",mac_algorithm:"hmac-sha1"};var e=a.oncomplete;e&&(b.oncomplete=function(){e()}),a&&a.success&&(b.success=a.success),b.stackmob_onrefreshToken=StackMob.processLogin,b.error=function(){a&&a.error&&a.error(),StackMob.Storage.remove(StackMob.REFRESH_TOKEN_KEY)},(this.sync||Backbone.sync).call(this,"refreshToken",this,b)}else a&&a.error&&a.error()},makeAPICall:function(a,b,c,d){return StackMob.ajax?StackMob.ajax(a,b,c,d):StackMob.isSencha()?StackMob.ajaxOptions.sencha(a,b,c,d):StackMob.isZepto()?StackMob.ajaxOptions.zepto(a,b,c,d):StackMob.ajaxOptions.jquery(a,b,c,d)},onsuccess:function(a,b,c,d,e,f){if(c&&(_.isFunction(c["stackmob_on"+b])&&c["stackmob_on"+b](d,f),_.isFunction(c.oncomplete)&&c.oncomplete(d)),e)if(d)if(StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(b)&&d.stackmob){d=d.stackmob.user;var g=f.fullyPopulateUser===!0;if(a&&a.parse)if(g){if(!a.set(a.parse(d,f),f))return!1}else{var h={};if(h[a.getPrimaryKeyField()]=d[a.getPrimaryKeyField()],!a.set(h,f))return!1}e(d),g&&a&&a.trigger&&a.trigger("sync",a,d,f)}else e(d);else e()},onerror:function(a,b,d,e,f,g){var h,i=a.status;try{h=JSON.parse(b)}catch(j){h={error:"Invalid JSON returned."}}if(503==i){var k=a.getResponseHeader("retry-after");try{k=1e3*parseInt(responseHeaderValue,10)}catch(j){k=StackMob.RETRY_WAIT}if("number"==typeof f.stackmob_retry){if(f.stackmob_retry-=1,f.stackmob_retry<=0)return}else f.stackmob_retry=StackMob.RETRY_ATTEMPTS;_.delay(function(){var a=c(f);f.headers.Authorization=a,d&&d(f)},k)}else _.isFunction(f.oncomplete)&&f.oncomplete(h),g&&g(h)},isAccessTokenMethod:function(a){var b=["accessToken","refreshToken","facebookAccessToken","facebookAccessTokenWithCreate","gigyaAccessToken"];return _.include(b,a)},_isSecureMethod:function(a,b){var c=["loginWithTempAndSetNewPassword","createUserWithFacebook","linkUserWithFacebook","unlinkUserFromFacebook","linkUserWithGigya","unlinkUserFromGigya"];return StackMob.isAccessTokenMethod(a)?!0:b.isUserCreate===!0?!0:_.include(c,a)}});var i=function(){StackMob.Model=Backbone.Model.extend({urlRoot:StackMob.getBaseURL(),getBinaryFields:function(){return this.binaryFields||[]},url:function(){var a=StackMob.getBaseURL();return a+=this.schemaName},getPrimaryKeyField:function(){return this.schemaName+"_id"},constructor:function(){this.setIDAttribute(),Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){StackMob.getProperty(this,"schemaName")||StackMob.throwError("A schemaName must be defined"),this.setIDAttribute()},setIDAttribute:function(){this.idAttribute=this.getPrimaryKeyField()},sync:function(a,b,c){return StackMob.sync.call(this,a,this,c),StackMob.sync.call(this,a,this,c)},create:function(a){var b={};return b[StackMob.FORCE_CREATE_REQUEST]=!0,_.extend(b,a),this.save(null,b)},query:function(a,b){return b=b||{},_.extend(b,{query:a}),this.fetch(b)},fetch:function(a){return StackMob.wrapStackMobCallbacks.call(this,a),Backbone.Model.prototype.fetch.call(this,a)},destroy:function(a){return StackMob.wrapStackMobCallbacks.call(this,a),Backbone.Model.prototype.destroy.call(this,a)},save:function(a,b){var c=a?a.success:{},d=a?a.error:{};return"undefined"==typeof b&&(_.isFunction(c)||_.isFunction(d))?(StackMob.wrapStackMobCallbacks.call(this,a),Backbone.Model.prototype.save.call(this,null,a)):(StackMob.wrapStackMobCallbacks.call(this,b),Backbone.Model.prototype.save.call(this,a,b))},fetchExpanded:function(a,b){(0>a||a>3)&&StackMob.throwError("Depth must be between 0 and 3 inclusive.");var c={};return _.extend(c,b),c.data=c.data||{},c.data._expand=a,this.fetch(c)},getAsModel:function(a,b){var c=this.get(a);return c?_.isArray(c)?_.map(c,function(a){return new b(a)}):new b(c):{}},appendAndCreate:function(a,b,c){return this.addRelationship(a,b,c)},addRelationship:function(a,b,c){return c=c||{},c[StackMob.ARRAY_FIELDNAME]=a,c[StackMob.ARRAY_VALUES]=b,StackMob.sync.call(this,"addRelationship",this,c)},appendAndSave:function(a,b,c){return c=c||{},c[StackMob.ARRAY_FIELDNAME]=a,c[StackMob.ARRAY_VALUES]=b,StackMob.sync.call(this,"appendAndSave",this,c)},deleteAndSave:function(a,b,c,d){d=d||{},d[StackMob.ARRAY_FIELDNAME]=a,d[StackMob.ARRAY_VALUES]=b,d[StackMob.CASCADE_DELETE]=c;var e=this;return d.stackmob_ondeleteAndSave=function(){var c=e.get(a);e.set(a,_.difference(c,b))},StackMob.sync.call(this,"deleteAndSave",this,d)},setBinaryFile:function(a,b,c,d){var e="Content-Type: "+c+"\n"+"Content-Disposition: attachment; "+"filename="+b+"\n"+"Content-Transfer-Encoding: base64\n\n"+d;this.set(a,e)},incrementOnSave:function(a,b){this.attributes[this.idAttribute]?(this.attributes[a]&&delete this.attributes[a],this.set(a+"[inc]",b)):StackMob.throwError("Please specify an id for the row you wish to update. When creating a new instance of your object, you need to pass in JSON that includes the id field and value (e.g. var user = new StackMob.User({ username: 'chucknorris' });)  Or, for custom objects: var todoInstance = new Todo({todo_id : '1234'})")},decrementOnSave:function(a,b){this.incrementOnSave(a,-1*b)}})},j=function(){StackMob.Collection=Backbone.Collection.extend({initialize:function(){this.model||StackMob.throwError("Please specify a StackMob.Model for this collection. e.g., var Items = StackMob.Collection.extend({ model: Item });"),this.schemaName=(new this.model).schemaName},url:function(){var a=StackMob.getBaseURL();return a+=this.schemaName},sync:function(a,b,c){return StackMob.sync.call(this,a,this,c)},query:function(a,b){return b=b||{},_.extend(b,{query:a}),this.fetch(b)},destroyAll:function(a,b){b=b||{};var c=this,d=b.success,e=function(a){c.remove(c.models),"function"==typeof d&&d(a)};return b.success=e,_.extend(b,{query:a}),(this.sync||Backbone.sync).call(this,"delete",this,b)},create:function(a,b){var c={};return c[StackMob.FORCE_CREATE_REQUEST]=!0,_.extend(c,b),StackMob.wrapStackMobCallbacks.call(this,c),Backbone.Collection.prototype.create.call(this,a,c)},fetch:function(a){return StackMob.wrapStackMobCallbacks.call(this,a),Backbone.Collection.prototype.fetch.call(this,a)},createAll:function(a){return a=a||{},(this.sync||Backbone.sync).call(this,"create",this,a)},count:function(a,b){a=a.clone()||new StackMob.Collection.Query,b=b||{},b.stackmob_count=!0;var c=b.success,d=function(a){if(_xhr=a,a&&a.getAllResponseHeaders){var b=a.getResponseHeader("Content-Range"),d=0;if(b&&(d=b.substring(b.indexOf("/")+1,b.length)),0===d)try{d=JSON.parse(a.responseText).length}catch(e){}c&&c(d)}else c&&c(a)};return b.success=d,a.setRange&&(b.query=a.setRange(0,0)),(this.sync||Backbone.sync).call(this,"query",this,b)}})},k=function(){function a(a){return"[and"+a+"]."}function b(a){return"[or"+a+"]."}StackMob.User=StackMob.Model.extend({schemaName:StackMob.userSchema||StackMob.DEFAULT_LOGIN_SCHEMA,loginField:StackMob.loginField||StackMob.DEFAULT_LOGIN_FIELD,passwordField:StackMob.passwordField||StackMob.DEFAULT_PASSWORD_FIELD,idAttribute:this.loginField,getPrimaryKeyField:function(){return this.loginField},create:function(a){return a=a||{},a.isUserCreate=!0,StackMob.Model.prototype.create.call(this,a)},isLoggedIn:function(a){return a=a||{},StackMob._containsCallbacks(a,["yes","no"])?(a=StackMob._generateCallbacks(a,{isValidResult:function(a){return"undefined"!=typeof a},yes:a.yes,no:a.no,error:a.no}),StackMob.hasValidOAuth(a),void 0):StackMob.isUserLoggedIn(this.get(this.loginField),a)},login:function(a,b){b=b||{};var c="undefined"==typeof a?!1:a;return StackMob.keepLoggedIn(c),b.data=b.data||{},b.data[this.loginField]=this.get(this.loginField),b.data[this.passwordField]=this.get(this.passwordField),StackMob.isOAuth2Mode()&&(b.data.token_type="mac"),b.stackmob_onaccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,StackMob.isOAuth2Mode()?"accessToken":"login",this,b)},logout:function(a){a=a||{},a.data=a.data||{},(this.sync||Backbone.sync).call(this,"logout",this,a),StackMob.clearOAuthCredentials()},loginWithGigya:function(a,b,c,d,e){e=e||{};var f="undefined"==typeof d?!1:d;return StackMob.keepLoggedIn(f),e.data=e.data||{},_.extend(e.data,{gigya_uid:a,gigya_ts:b,gigya_sig:c,token_type:"mac"}),e.stackmob_ongigyaAccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,"gigyaAccessToken",this,e)},linkUserWithGigya:function(a,b,c,d){return d=d||{},d.data=d.data||{},_.extend(d.data,{gigya_uid:a,gigya_ts:b,gigya_sig:c,token_type:"mac"}),(this.sync||Backbone.sync).call(this,"linkUserWithGigya",this,d)},unlinkUserFromGigya:function(a){return(this.sync||Backbone.sync).call(this,"unlinkUserFromGigya",this,a)},loginWithFacebook:function(a,b,c){return this.loginWithFacebookToken(a,b,c)},loginWithFacebookToken:function(a,b,c){c=c||{};var d="undefined"==typeof b?!1:b;return StackMob.keepLoggedIn(d),c.data=c.data||{},_.extend(c.data,{fb_at:a,token_type:"mac"}),c.createIfNeeded===!0?(c.stackmob_onfacebookAccessTokenWithCreate=StackMob.processLogin,c.data[this.loginField]=c[this.loginField]||this.get(this.loginField),(this.sync||Backbone.sync).call(this,"facebookAccessTokenWithCreate",this,c)):(c.stackmob_onfacebookAccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,"facebookAccessToken",this,c))},loginWithFacebookAutoCreate:function(a,b,c){return c=c||{},c.createIfNeeded=!0,this.loginWithFacebookToken(a,b,c)},createUserWithFacebook:function(a,b){return b=b||{},b.data=b.data||{},_.extend(b.data,{fb_at:a,token_type:"mac"}),b.data[this.loginField]=b[this.loginField]||this.get(this.loginField),(this.sync||Backbone.sync).call(this,"createUserWithFacebook",this,b)},linkUserWithFacebook:function(a,b){return b=b||{},b.data=b.data||{},_.extend(b.data,{fb_at:a,token_type:"mac"}),(this.sync||Backbone.sync).call(this,"linkUserWithFacebook",this,b)},unlinkUserFromFacebook:function(a){return(this.sync||Backbone.sync).call(this,"unlinkUserFromFacebook",this,a)},loginWithTempAndSetNewPassword:function(a,b,c,d){return d=d||{},d.data=d.data||{},this.set(this.passwordField,a),d.data[StackMob.newPasswordField]=b,this.login(c,d)},forgotPassword:function(a){return a=a||{},a.data=a.data||{},a.data.username=this.get(this.loginField),(this.sync||Backbone.sync).call(this,"forgotPassword",this,a)},resetPassword:function(a,b,c){return c=c||{},c.data=c.data||{},c.data.old={password:a},c.data["new"]={password:b},(this.sync||Backbone.sync).call(this,"resetPassword",this,c)},sync:function(a,b,c){return c=c||{},c.stackmob_userschemainfo={schemaName:this.schemaName,loginField:this.loginField,passwordField:this.passwordField},StackMob.Model.prototype.sync.call(this,a,b,c)}}),StackMob.Users=StackMob.Collection.extend({model:StackMob.User}),StackMob.GeoPoint=function(a,b){_.isNumber(a)?((-90>a||a>90)&&StackMob.throwError("Latitude value must be between -90 and 90 inclusive."),(-180>b||b>180)&&StackMob.throwError("Longitude value must be between -180 and 180 inclusive."),this.lat=a,this.lon=b):((a.lat<-90||a.lat>90)&&StackMob.throwError("Latitude value must be between -90 and 90 inclusive."),(a.lon<-180||a.lon>180)&&StackMob.throwError("Longitude value must be between -180 and 180 inclusive."),this.lat=a.lat,this.lon=a.lon)},StackMob.GeoPoint.prototype.toJSON=function(){return{lat:this.lat,lon:this.lon}},StackMob.Model.Query=function(){this.selectFields=[],this.params={}},_.extend(StackMob.Model.Query.prototype,{select:function(a){return this.selectFields.push(a),this},setExpand:function(a){return this.params._expand=a,this}}),StackMob.Collection.Query=function(){this.params={},this.selectFields=[],this.orderBy=[],this.range=null},StackMob.Collection.Query.prototype=new StackMob.Model.Query,StackMob.Collection.Query.prototype.constructor=StackMob.Collection.Query(),_.extend(StackMob.Collection.Query.prototype,{or:function(c){var d,e=this;return"undefined"==typeof this.orId?(function(){d=this.clone(),d.params={},d.orId=1,d.andCount=1;var f,g,h;g=_.keys(e.params),h="",g.length>1&&(f=d.andCount++,h=a(f));var i;for(var j in e.params)i=b(d.orId)+h+j,d.params[i]=e.params[j];g=_.keys(c.params),h="",g.length>1&&(f=d.andCount++,h=a(f));for(j in c.params){if(i=b(d.orId)+h+j,"undefined"!=typeof d.params[i])throw new Error("Error: You are attempting to OR two or more values for the same field. You should use an mustBeOneOf method instead.");d.params[i]=c.params[j]}}(),d):(function(){d=this.clone();var e=_.keys(c.params);parsedAndString="",e.length>1&&(andCounter=d.andCount++,parsedAndString=a(andCounter));for(var f in c.params){var g=b(d.orId)+parsedAndString+f;if("undefined"!=typeof d.params[g])throw new Error("Error: You are attempting to OR two or more values for the same field. You should use an mustBeOneOf method instead.");d.params[g]=c.params[f]}}(),d)},and:function(a){var b=this.clone();for(var c in a.params)b.params[c]=a.params[c];return b},clone:function(){var a=_.clone(this);return a.params=_.clone(this.params),a},addParam:function(a,b){return this.params[a]=b,this},equals:function(a,b){return""===b?this.params[a+"[empty]"]=!0:this.params[a]=b,this},lt:function(a,b){return this.params[a+"[lt]"]=b,this},lte:function(a,b){return this.params[a+"[lte]"]=b,this},gt:function(a,b){return this.params[a+"[gt]"]=b,this},gte:function(a,b){return this.params[a+"[gte]"]=b,this},notEquals:function(a,b){return""===b?this.params[a+"[empty]"]=!1:this.params[a+"[ne]"]=b,this},isNull:function(a){return this.params[a+"[null]"]=!0,this},isNotNull:function(a){return this.params[a+"[null]"]=!1,this},mustBeOneOf:function(a,b){var c="";return c=_.isArray(b)?b.join():b,this.params[a+"[in]"]=c,this},mustNotBeOneOf:function(a,b){var c="";return c=_.isArray(b)?b.join():b,this.params[a+"[nin]"]=c,this},orderAsc:function(a){return this.orderBy.push(a+":asc"),this},orderDesc:function(a){return this.orderBy.push(a+":desc"),this},setRange:function(a,b){return this.range={start:a,end:b},this},mustBeNear:function(a,b,c){return this.params[a+"[near]"]=b.lat+","+b.lon+","+c,this},mustBeNearMi:function(a,b,c){return this.mustBeNear(a,b,c/StackMob.EARTH_RADIANS_MI),this},mustBeNearKm:function(a,b,c){return this.mustBeNear(a,b,c/StackMob.EARTH_RADIANS_KM),this},isWithin:function(a,b,c){return this.params[a+"[within]"]=b.lat+","+b.lon+","+c,this},isWithinMi:function(a,b,c){return this.isWithin(a,b,c/StackMob.EARTH_RADIANS_MI),this},isWithinKm:function(a,b,c){return this.isWithin(a,b,c/StackMob.EARTH_RADIANS_KM),this},isWithinBox:function(a,b,c){return this.params[a+"[within]"]=b.lat+","+b.lon+","+c.lat+","+c.lon,this}})}}.call(this),function(){var a=this,b=a.jQuery||a.Ext||a.Zepto;_.extend(StackMob,{ajaxOptions:{sencha:function(a,c,d,e){var f={},g=c.success,h=function(b){var f=null;if(b&&b.responseText)try{f=JSON.parse(b.responseText)}catch(h){f=b.responseText}c.stackmob_count===!0&&(f=b),StackMob.onsuccess(a,d,c,f,g,e)};c.success=h;var i=c.error;f.url=c.url,f.headers=c.headers,f.params=c.data,f.success=c.success,f.disableCaching=!1,f.method=c.type;var j=function(c,d){var e=c.responseText||c.text;StackMob.onerror(c,e,b.Ajax.request,a,f,i,d)};return c.error=j,f.failure=c.error,b.Ajax.request(f)},zepto:function(a,c,d,e){var f=c.success,g=function(b,g){g=b;try{g=JSON.parse(b)}catch(h){}StackMob.onsuccess(a,d,c,g,f,e)};c.success=g;var h=c.error,i=function(d){var f=d.responseText||d.text;StackMob.onerror(d,f,b.ajax,a,c,h,e)};c.error=i;var j={};return j.url=c.url,j.headers=c.headers,j.contentType=c.headers.contentType,j.type=c.type,j.data=c.data,j.success=g,j.error=i,b.ajax(j)},jquery:function(a,c,d,e){c.converters={"text json":function(a){return"string"==typeof a&&b.trim(a).length?jQuery.parseJSON(a):{}}},c.beforeSend=function(a,b){if(a.setRequestHeader("Accept",b.accepts),!_.isEmpty(b.headers))for(var c in b.headers)a.setRequestHeader(c,b.headers[c])};var f=c.error;c.error=function(d,g,h){if(0===d.status&&c.query&&"object"==typeof c.query.range)return this.success(d,g,h),void 0;var i=d.responseText||d.text;StackMob.onerror(d,i,b.ajax,a,c,f,e)};var g=c.success,h=function(b,f,h){var i;if(c.stackmob_count===!0)i=h;else if(b&&b.toJSON)i=b;else if(b&&(b.responseText||b.text))try{i=JSON.parse(b.responseText||b.text)}catch(j){i=b.responseText||b.text}else b&&(i=b);StackMob.onsuccess(a,d,c,i,g,e)};return c.success=h,b.ajax(c)}}})}.call(this);var CryptoJS=CryptoJS||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(255&c[e>>>2]>>>24-8*(e%4))<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(0|4294967296*a.random());return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=255&b[d>>>2]>>>24-8*(d%4);c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")
},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(255&b[d>>>2]>>>24-8*(d%4)));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(){var a=CryptoJS,b=a.lib,c=b.WordArray,d=b.Hasher,e=[],b=a.algo.SHA1=d.extend({_doReset:function(){this._hash=new c.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(a,b){for(var c=this._hash.words,d=c[0],f=c[1],g=c[2],h=c[3],i=c[4],j=0;80>j;j++){if(16>j)e[j]=0|a[b+j];else{var k=e[j-3]^e[j-8]^e[j-14]^e[j-16];e[j]=k<<1|k>>>31}k=(d<<5|d>>>27)+i+e[j],k=20>j?k+((f&g|~f&h)+1518500249):40>j?k+((f^g^h)+1859775393):60>j?k+((f&g|f&h|g&h)-1894007588):k+((f^g^h)-899497514),i=h,h=g,g=f<<30|f>>>2,f=d,d=k}c[0]=0|c[0]+d,c[1]=0|c[1]+f,c[2]=0|c[2]+g,c[3]=0|c[3]+h,c[4]=0|c[4]+i},_doFinalize:function(){var a=this._data,b=a.words,c=8*this._nDataBytes,d=8*a.sigBytes;return b[d>>>5]|=128<<24-d%32,b[(d+64>>>9<<4)+14]=Math.floor(c/4294967296),b[(d+64>>>9<<4)+15]=c,a.sigBytes=4*b.length,this._process(),this._hash},clone:function(){var a=d.clone.call(this);return a._hash=this._hash.clone(),a}});a.SHA1=d._createHelper(b),a.HmacSHA1=d._createHmacHelper(b)}(),function(){var a=CryptoJS,b=a.enc.Utf8;a.algo.HMAC=a.lib.Base.extend({init:function(a,c){a=this._hasher=new a.init,"string"==typeof c&&(c=b.parse(c));var d=a.blockSize,e=4*d;c.sigBytes>e&&(c=a.finalize(c)),c.clamp();for(var f=this._oKey=c.clone(),g=this._iKey=c.clone(),h=f.words,i=g.words,j=0;d>j;j++)h[j]^=1549556828,i[j]^=909522486;f.sigBytes=g.sigBytes=e,this.reset()},reset:function(){var a=this._hasher;a.reset(),a.update(this._iKey)},update:function(a){return this._hasher.update(a),this},finalize:function(a){var b=this._hasher;return a=b.finalize(a),b.reset(),b.finalize(this._oKey.clone().concat(a))}})}(),function(){var a=CryptoJS,b=a.lib,c=b.WordArray,d=a.enc;d.Base64={stringify:function(a){var b=a.words,c=a.sigBytes,d=this._map;a.clamp();for(var e=[],f=0;c>f;f+=3)for(var g=255&b[f>>>2]>>>24-8*(f%4),h=255&b[f+1>>>2]>>>24-8*((f+1)%4),i=255&b[f+2>>>2]>>>24-8*((f+2)%4),j=g<<16|h<<8|i,k=0;4>k&&c>f+.75*k;k++)e.push(d.charAt(63&j>>>6*(3-k)));var l=d.charAt(64);if(l)for(;e.length%4;)e.push(l);return e.join("")},parse:function(a){var b=a.length,d=this._map,e=d.charAt(64);if(e){var f=a.indexOf(e);-1!=f&&(b=f)}for(var g=[],h=0,i=0;b>i;i++)if(i%4){var j=d.indexOf(a.charAt(i-1))<<2*(i%4),k=d.indexOf(a.charAt(i))>>>6-2*(i%4);g[h>>>2]|=(j|k)<<24-8*(h%4),h++}return c.create(g,h)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();